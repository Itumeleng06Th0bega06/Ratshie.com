

{%extends 'base.html' %}
{% load static %}
{% block content %}

  
<br/><br/>

<div class="container py-5">
  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">Your Shopping Cart</h2>
        </div>
        
        <div class="card-body p-0">
          {% if cart_products %}
              <div class="table-responsive">
                <table class="table mb-0">
                  <thead class="bg-light">
                    <tr>
                      <th class="border-0" style="width: 45%">Product</th>
                      <th class="border-0 text-center">Price</th>
                      <th class="border-0 text-center">Quantity</th>
                      
                      <th class="border-0"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for product in cart_products %}
                    <tr class="cart-product">
                      <td class="align-middle">
                        <div class="d-flex align-items-center">
                          {% if product.image %}
                          <img src="{{ product.image.url }}" alt="{{ product.name }}" 
                          class="img-fluid rounded mr-3" style="max-height: 60px">
                          {% endif %}
                          <div>
                            <h6 class="mb-1">{{ product.name }}</h6>
                            <small class="text-muted">SKU: {{ product.id }}</small>
                          </div>
                        </div>
                      </td>
                      
                      {%if product.sale_price %}
                      <td class="align-middle text-center">R{{ product.sale_price }}</td>
                        
                      {% else %}
                      <td class="align-middle text-center">R{{ product.price }}</td>
                      {% endif %}
                      <td class="align-middle text-center">
                    
                        
                        <div class="quantity-control d-flex justify-content-center">
                          <form action="{% url 'cart_update' %}" method="post">
                            {% csrf_token %}
                            <button type="button" data-index="{{product.id}}" class="btn btn-sm btn-outline-info px-3 update-cart">update</button>
                          </form>&nbsp;&nbsp;
                          <select class="form-select" id="select{{product.id}}">
                            <option selcted>
                              {% for key, value in quantities.items%}
                              {% if key == product.id|slugify%}
                              {{value}}
                              {% endif %}
                              {% endfor%}
                            </option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                          </select>&nbsp;&nbsp;
                          <form action="{% url 'cart_delete' %}" method="post">
                            {% csrf_token %}
                            <button type="button" data-index="{{product.id}}" class="btn btn-sm btn-outline-info px-3 delete-product">remove</button>
                          </form>
                          </div>
                        
                        
                        
                      </td>
                      
                      
                      <td class="align-middle text-right">
                        
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <a href = "{% url 'home' %}" class = "btn btn-block mt-4 py-1 btn-primary">Continue Shopping</a>
              
              
              {% else %}
              <div class="text-center py-5">
                <i class="fas fa-shopping-cart fa-4x text-muted mb-4"></i>
            <h4>Your cart is empty</h4>
            <p class="text-muted">You haven't added any items yet</p>
            <a href="{% url 'home' %}" class="btn btn-primary mt-3">
              <i class="fas fa-arrow-left mr-2"></i>Continue Shopping
            </a>
          </div>
          
          {% endif %}
          
        </div>
        
        
      </div>
    </div>
    
    
    <div class="col-lg-4">
      <div class="card shadow-sm sticky-top" style="top: 20px">
        <div class="card-header bg-white">
          <h3 class="h6 mb-0">Order Summary</h3>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">

            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
              <span>Shipping</span>
              <span>Included</span>
            </li>
           
            <li class="list-group-item d-flex justify-content-between align-items-center px-0 font-weight-bold">
              <span>Total</span>
              <span>R{{ totals|floatformat:2 }}</span>
            </li>
          </ul>
          
          <a href="{% url 'checkout' %}" class="btn btn-primary btn-block mt-4 py-3">
            Proceed to Checkout
          </a>
          <div class="text-center mt-3">
            <small class="text-muted">
              <i class="fas fa-lock mr-1"></i> Secure checkout
            </small>
          </div>
        </div>
      </div>
    </div>
    
  </div>
</div>

<script>
  // check if button pressed
  $(document).on('click', '.update-cart', function(e){
    e.preventDefault();
    // get product_id
    var productid = $(this).data('index');
    $.ajax({
      type: 'POST',
      url: '{% url 'cart_update' %}',
      data: {
        product_id: $(this).data('index'),
        product_qty: $('#select' + productid + ' option:selected').text(),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(json){
        //console.log(json)
        //document.getElementById("cart_quantity").textContent = json.qty
        location.reload();
      },
      error: function(xhr, errmsg, err){
        
      }
    });
  })

  //detlete
  $(document).on('click', '.delete-product', function(e){
    e.preventDefault();
    // get product_id
    //var productid = $(this).data('index');
    $.ajax({
      type: 'POST',
      url: '{% url 'cart_delete' %}',
      data: {
        product_id: $(this).data('index'),
        csrfmiddlewaretoken: '{{ csrf_token }}',
        action: 'post'
      },
      success: function(json){
        //console.log(json)
        //document.getElementById("cart_quantity").textContent = json.qty
        location.reload();
      },
      error: function(xhr, errmsg, err){
        
      }
    });
  })
</script>




    
    

{% endblock %}